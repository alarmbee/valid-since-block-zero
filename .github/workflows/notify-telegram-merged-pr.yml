name: Notify Telegram on merged PR

on:
  pull_request:
    types: [closed]

permissions:
  pull-requests: read

jobs:
  notify:
    name: Send merged PR to Telegram
    if: ${{ github.event.pull_request.merged == true }}
    runs-on: ubuntu-latest
    steps:
      - name: Send Telegram message
        uses: actions/github-script@v7
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_MESSAGE_THREAD_ID: ${{ secrets.TELEGRAM_MESSAGE_THREAD_ID }}
        with:
          script: |
            const token = process.env.TELEGRAM_BOT_TOKEN;
            const chatId = process.env.TELEGRAM_CHAT_ID;
            const threadId = process.env.TELEGRAM_MESSAGE_THREAD_ID;

            if (!token || !chatId) {
              core.setFailed('Missing required secrets: TELEGRAM_BOT_TOKEN and/or TELEGRAM_CHAT_ID.');
              return;
            }

            const pr = context.payload.pull_request;
            const repo = `${context.repo.owner}/${context.repo.repo}`;
            const number = pr.number ?? '';
            const base = pr.base?.ref ?? '';
            const title = pr.title ?? '';
            const body = pr.body ?? '';
            const url = pr.html_url ?? '';
            const author = pr.user?.login ?? 'unknown';
            const mergedBy = pr.merged_by?.login ?? 'unknown';

            const summary = body.trim().length ? body.trim() : '(no description)';
            const maxLen = 1200;
            const shortSummary = summary.length > maxLen ? summary.slice(0, maxLen - 1) + '…' : summary;

            const escapeHtml = (s) => String(s)
              .replaceAll('&', '&amp;')
              .replaceAll('<', '&lt;')
              .replaceAll('>', '&gt;');

            const text = [
              `<b>Merged PR</b> <code>${escapeHtml(repo)}#${escapeHtml(number)}</code> → <code>${escapeHtml(base)}</code>`,
              `<b>${escapeHtml(title)}</b>`,
              '',
              `${escapeHtml(shortSummary)}`,
              '',
              `<a href="${escapeHtml(url)}">Open on GitHub</a>`,
              `<i>Author:</i> ${escapeHtml(author)}  <i>Merged by:</i> ${escapeHtml(mergedBy)}`,
            ].join('\n');

            const params = new URLSearchParams();
            params.set('chat_id', chatId);
            params.set('text', text);
            params.set('parse_mode', 'HTML');
            params.set('disable_web_page_preview', 'true');
            if (threadId) params.set('message_thread_id', threadId);

            const resp = await fetch(`https://api.telegram.org/bot${token}/sendMessage`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
              body: params.toString(),
            });

            const json = await resp.json().catch(() => ({}));
            if (!resp.ok || !json.ok) {
              core.setFailed(
                `Telegram sendMessage failed (${resp.status} ${resp.statusText}): ${JSON.stringify(json)}`
              );
              return;
            }

            core.info(`Telegram message sent: message_id=${json.result?.message_id}`);
